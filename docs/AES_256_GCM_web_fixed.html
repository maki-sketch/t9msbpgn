<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AES-GCM ç¦»çº¿åŠ å¯†è§£å¯†å·¥å…·</title>
    <style>
        :root {
            --primary-color: #2563eb;
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --text-color: #1e293b;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .card {
            background: var(--card-bg);
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }
        h1, h2 { text-align: center; color: #0f172a; }
        .group { margin-bottom: 1.5rem; }
        label { display: block; font-weight: 600; margin-bottom: 0.5rem; }
        input[type="text"], input[type="number"], input[type="password"], textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            box-sizing: border-box;
            font-family: monospace;
        }
        textarea { height: 100px; resize: vertical; }
        .btn-group { display: flex; gap: 10px; flex-wrap: wrap; }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: opacity 0.2s;
        }
        .btn-primary { background: var(--primary-color); color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-gen { background: #64748b; color: white; }
        button:hover { opacity: 0.9; }
        button:disabled { background: #cbd5e1; cursor: not-allowed; }
        .status { margin-top: 10px; font-size: 0.9rem; color: #64748b; }
        .footer { text-align: center; font-size: 0.8rem; color: #94a3b8; }
        hr { border: 0; border-top: 1px solid #e2e8f0; margin: 2rem 0; }
        .back-btn {
            display: inline-block;
            padding: 8px 16px;
            background: #e2e8f0;
            color: #475569;
            border-radius: 6px;
            margin-bottom: 1rem;
        }
        .back-btn:hover {
            background: #cbd5e1;
        }
    </style>
</head>
<body>

<div class="container">
    <div style="margin: 20px 0;">
        <a href="index.html" class="back-btn">â† è¿”å›é¦–é¡µ</a>
        <a href="tools.html" class="back-btn" style="margin-left: 10px;">â† è¿”å›å·¥å…·åˆ—è¡¨</a>
    </div>

    <h1>ğŸ” AES-256-GCM ç¦»çº¿åŠ å¯†å·¥å…·</h1>
    
    <!-- å¯†ç ç”Ÿæˆå™¨ -->
    <div class="card">
        <h2>1. ç”Ÿæˆéšæœºå¯†ç </h2>
        <div class="group">
            <label>å¯†ç é•¿åº¦ (ä½æ•°):</label>
            <input type="number" id="passLength" value="16" min="4" max="128">
        </div>
        <div class="btn-group">
            <button class="btn-gen" onclick="generatePassword()">ç”Ÿæˆéšæœºå¯†ç </button>
        </div>
        <div class="group" style="margin-top: 10px;">
            <input type="text" id="generatedPass" readonly placeholder="ç”Ÿæˆçš„å¯†ç ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ">
            <button class="btn-gen" style="margin-top:5px; padding:5px 10px; font-size:0.8rem;" onclick="copyPassword()">å¤åˆ¶åˆ°ä¸‹æ–¹åŠ å¯†æ¡†</button>
        </div>
    </div>

    <!-- åŠ å¯†è§£å¯†ä¸»åŒºåŸŸ -->
    <div class="card">
        <h2>2. åŠ å¯† / è§£å¯†</h2>
        
        <div class="group">
            <label>ä¸»å¯†é’¥ (åŠ å¯†å£ä»¤):</label>
            <input type="password" id="mainKey" placeholder="è¾“å…¥ç”¨äºåŠ å¯†/è§£å¯†çš„å¯†ç ">
        </div>

        <hr>

        <!-- æ–‡å­—æ¨¡å¼ -->
        <div class="group">
            <label>å¾…å¤„ç†æ–‡å­—:</label>
            <textarea id="inputText" placeholder="è¾“å…¥æ˜æ–‡(å‡†å¤‡åŠ å¯†)æˆ– Base64 å¯†æ–‡(å‡†å¤‡è§£å¯†)"></textarea>
        </div>

        <div class="btn-group">
            <button class="btn-primary" onclick="processText(true)">åŠ å¯†æ–‡å­—</button>
            <button class="btn-success" onclick="processText(false)">è§£å¯†æ–‡å­—</button>
        </div>

        <div class="group" style="margin-top: 1.5rem;">
            <label>ç»“æœ:</label>
            <textarea id="outputText" readonly placeholder="å¤„ç†ç»“æœå°†åœ¨æ­¤æ˜¾ç¤º"></textarea>
        </div>

        <hr>

        <!-- æ–‡ä»¶æ¨¡å¼ -->
        <div class="group">
            <label>å¤„ç†æ–‡ä»¶:</label>
            <input type="file" id="inputFile">
            <p style="font-size: 0.8rem; color: #64748b;">æ³¨:å¤§æ–‡ä»¶å¤„ç†å–å†³äºæ‚¨çš„æµè§ˆå™¨å†…å­˜ã€‚</p>
        </div>
        <div class="btn-group">
            <button class="btn-primary" onclick="processFile(true)">åŠ å¯†å¹¶ä¸‹è½½æ–‡ä»¶</button>
            <button class="btn-success" onclick="processFile(false)">è§£å¯†å¹¶ä¸‹è½½æ–‡ä»¶</button>
        </div>
        <div id="fileStatus" class="status"></div>
    </div>

    <div class="footer">
        ä½¿ç”¨æµè§ˆå™¨åŸç”Ÿ Web Crypto API (AES-GCM 256bit) | å®Œå…¨ç¦»çº¿è¿è¡Œ
    </div>
</div>

<script>
    /**
     * å¯†ç ç”Ÿæˆé€»è¾‘
     */
    function generatePassword() {
        const length = document.getElementById('passLength').value;
        const charset = "abcdefghijklmnopqrstuvwxyz0123456789";
        let retVal = "";
        const values = new Uint32Array(length);
        window.crypto.getRandomValues(values);
        for (let i = 0; i < length; i++) {
            retVal += charset.charAt(values[i] % charset.length);
        }
        document.getElementById('generatedPass').value = retVal;
    }

    function copyPassword() {
        const pass = document.getElementById('generatedPass').value;
        if (pass) document.getElementById('mainKey').value = pass;
    }

    /**
     * æ ¸å¿ƒåŠ å¯†/è§£å¯†é€»è¾‘
     * ä½¿ç”¨ AES-GCM ç®—æ³•,PBKDF2 è¡ç”Ÿå¯†é’¥
     */
    const ITERATIONS = 300000;
    const SALT_BYTE_LEN = 16;
    const IV_BYTE_LEN = 12;

    async function deriveKey(password, salt) {
        const enc = new TextEncoder();
        const keyMaterial = await window.crypto.subtle.importKey(
            "raw", enc.encode(password), "PBKDF2", false, ["deriveKey"]
        );
        return window.crypto.subtle.deriveKey(
            {
                name: "PBKDF2",
                salt: salt,
                iterations: ITERATIONS,
                hash: "SHA-256"
            },
            keyMaterial,
            { name: "AES-GCM", length: 256 },
            false,
            ["encrypt", "decrypt"]
        );
    }

    // å¤„ç†æ–‡å­—
    async function processText(isEncrypt) {
        const password = document.getElementById('mainKey').value;
        const input = document.getElementById('inputText').value;
        
        if (!password || !input) {
            alert("è¯·è¾“å…¥å¯†ç å’Œå†…å®¹");
            return;
        }

        try {
            if (isEncrypt) {
                // åŠ å¯†
                const salt = window.crypto.getRandomValues(new Uint8Array(SALT_BYTE_LEN));
                const iv = window.crypto.getRandomValues(new Uint8Array(IV_BYTE_LEN));
                const key = await deriveKey(password, salt);
                
                const encodedText = new TextEncoder().encode(input);
                const ciphertext = await window.crypto.subtle.encrypt(
                    { name: "AES-GCM", iv: iv },
                    key,
                    encodedText
                );

                // åˆå¹¶ Salt + IV + Ciphertext
                const combined = new Uint8Array(salt.length + iv.length + ciphertext.byteLength);
                combined.set(salt, 0);
                combined.set(iv, salt.length);
                combined.set(new Uint8Array(ciphertext), salt.length + iv.length);
                
                // è½¬ä¸º Base64 è¾“å‡º
                document.getElementById('outputText').value = btoa(String.fromCharCode(...combined));
            } else {
                // è§£å¯†
                const combined = Uint8Array.from(atob(input), c => c.charCodeAt(0));
                const salt = combined.slice(0, SALT_BYTE_LEN);
                const iv = combined.slice(SALT_BYTE_LEN, SALT_BYTE_LEN + IV_BYTE_LEN);
                const data = combined.slice(SALT_BYTE_LEN + IV_BYTE_LEN);
                
                const key = await deriveKey(password, salt);
                const decrypted = await window.crypto.subtle.decrypt(
                    { name: "AES-GCM", iv: iv },
                    key,
                    data
                );
                
                document.getElementById('outputText').value = new TextDecoder().decode(decrypted);
            }
        } catch (e) {
            console.error(e);
            alert("é”™è¯¯:å¯èƒ½æ˜¯å¯†ç é”™è¯¯æˆ–æ•°æ®æŸåï¼Œä¹Ÿå¯èƒ½æ˜¯æ‚¨æ²¡æœ‰ä½¿ç”¨HTTPSè¿æ¥");
        }
    }

    // å¤„ç†æ–‡ä»¶
    async function processFile(isEncrypt) {
        const password = document.getElementById('mainKey').value;
        const fileInput = document.getElementById('inputFile');
        const status = document.getElementById('fileStatus');

        if (!password || !fileInput.files.length) {
            alert("è¯·è¾“å…¥å¯†ç å¹¶é€‰æ‹©æ–‡ä»¶");
            return;
        }

        const file = fileInput.files[0];
        status.innerText = "å¤„ç†ä¸­,è¯·ç¨å€™...";

        try {
            const arrayBuffer = await file.arrayBuffer();

            if (isEncrypt) {
                const salt = window.crypto.getRandomValues(new Uint8Array(SALT_BYTE_LEN));
                const iv = window.crypto.getRandomValues(new Uint8Array(IV_BYTE_LEN));
                const key = await deriveKey(password, salt);
                
                const ciphertext = await window.crypto.subtle.encrypt(
                    { name: "AES-GCM", iv: iv },
                    key,
                    arrayBuffer
                );

                const combined = new Uint8Array(salt.length + iv.length + ciphertext.byteLength);
                combined.set(salt, 0);
                combined.set(iv, salt.length);
                combined.set(new Uint8Array(ciphertext), salt.length + iv.length);

                downloadBlob(combined, file.name + ".enc");
                status.innerText = "åŠ å¯†å®Œæˆ!";
            } else {
                const combined = new Uint8Array(arrayBuffer);
                const salt = combined.slice(0, SALT_BYTE_LEN);
                const iv = combined.slice(SALT_BYTE_LEN, SALT_BYTE_LEN + IV_BYTE_LEN);
                const data = combined.slice(SALT_BYTE_LEN + IV_BYTE_LEN);
                
                const key = await deriveKey(password, salt);
                const decrypted = await window.crypto.subtle.decrypt(
                    { name: "AES-GCM", iv: iv },
                    key,
                    data
                );

                downloadBlob(decrypted, file.name.replace(".enc", ""));
                status.innerText = "è§£å¯†å®Œæˆ!";
            }
        } catch (e) {
            console.error(e);
            status.innerText = "é”™è¯¯:è§£å¯†å¤±è´¥,è¯·æ£€æŸ¥å¯†ç ã€‚";
        }
    }

    function downloadBlob(data, fileName) {
        const blob = new Blob([data], { type: "application/octet-stream" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = fileName;
        a.click();
        URL.revokeObjectURL(url);
    }
</script>

</body>
</html>
